#!/bin/sh

set -e

# parse options {{{
usage() {
	cat <<- 'EOU'
		Usage: git-fetch-rebase [-p] [remote-branch]

		  Options:
		    -p, --push       push if rebase successfully
	EOU
}

if ! TEMP=$(getopt -q -o hp --long help,push -- "$@"); then
    usage
    exit 1
fi

eval set -- "$TEMP"

_PUSH=false
while true; do
    case "$1" in
        -h | --help ) usage; exit 0 ;;
        -p | --push ) _PUSH=true; shift ;;
        -- ) shift; break ;;
    esac
done
#}}}

find_remote_tracked_branch() {
    git for-each-ref --format='%(upstream:short)' $(git symbolic-ref -q HEAD)
}

_REMOTE_BRANCH=${1:-$(find_remote_tracked_branch)}

if [ -z "$_REMOTE_BRANCH" ]; then
    >&2 echo 'No remote branch specified'
fi

git fetch && git rebase "$_REMOTE_BRANCH"
if [ $_PUSH = true ]; then
    git push
fi
